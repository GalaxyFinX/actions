name: Build image with Docker

description: |
  This action build an OCI image with Docker.

inputs:
  context:
    description: context flag
    default: "."
    required: false

  dockerfile:
    description: dockerfile flag
    default: Dockerfile
    required: false

  push:
    description: push image to registry
    required: false
    default: "false"

  tags:
    description: image tags
    required: true

  labels:
    description: image labels
    required: false

runs:
  using: composite
  steps:
    - run: |
        set -o errexit

        # Replace `spaces` by `-`
        LABELS=($(echo "${{ inputs.labels }}" | tr ' ' '-'))
        TAGS=($(echo "${{ inputs.tags }}" | tr ' ' '-'))

        # Build docker kargs
        [ -n "${{ inputs.dockerfile }}" ] && kargs="$kargs --file ${{ inputs.dockerfile }} "

        for tag in "${TAGS[@]}"; do
          kargs="$kargs --tag $tag "
        done

        for label in "${LABELS[@]}"; do
          kargs="$kargs --label \"$label\" "
        done

        # Execute docker build command
        echo "Docker flags: $kargs"
        docker build $kargs ${{ inputs.context }}
      shell: bash

    - if: ${{ inputs.push }} == 'true'
      run: |
        set -o errexit

        TAGS=($(echo "${{ inputs.tags }}" | tr ' ' '-'))

        for tag in "${TAGS[@]}"; do
          docker image push $tag
        done
      shell: bash
